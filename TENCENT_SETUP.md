# 腾讯云开发 云端数据接入（快速上线、少写后端）

用腾讯云开发 CloudBase 做后端，数据存云端，多人共享、换设备也能用。

## 一、注册并创建环境

1. 打开 [腾讯云开发控制台](https://console.cloud.tencent.com/tcb)
2. 登录腾讯云账号，创建环境（选「按量付费」或免费额度）
3. 创建完成后，在环境列表找到 **环境 ID**（形如 `xxx-xxxxx`）

## 二、配置项目

编辑 `js/config.js`，填入你的环境 ID：

```javascript
const TENCENT_ENV_ID = '你的环境ID';
```

## 三、开启匿名登录

1. 控制台 → 选择你的环境 → **登录授权**
2. 找到「匿名登录」，点击 **开启**

## 四、添加安全域名

1. 控制台 → **安全配置** → **Web 安全域名**
2. 添加你的网站域名（如 `localhost`、`127.0.0.1`、部署后的域名）
3. 本地开发需添加 `localhost` 或 `127.0.0.1`

## 五、创建数据库集合

1. 控制台 → **数据库** → **集合**
2. 点击「新建集合」，名称填：`LoveBase`（大小写必须一致）
3. 无需手动建字段，首次写入会自动创建

## 六、配置数据库权限（必做）

**重要**：CloudBase 默认安全规则会拒绝所有访问，必须手动放通。

1. 控制台 → **数据库** → 点击集合 `LoveBase` → **权限设置**
2. 切换到「安全规则」或「自定义安全规则」
3. 填入以下规则，允许已登录用户（含匿名）读写：

```json
{
  "read": "auth != null",
  "write": "auth != null"
}
```

4. 保存规则

## 七、部署

配置完成后，按 `DEPLOY.md` 部署到 Vercel / Netlify 等。部署后记得在安全域名中添加你的线上域名。

## 八、数据没进数据库？排查步骤

1. **打开浏览器控制台（F12）**，看是否有：
   - `腾讯云 初始化失败` → 检查匿名登录、安全域名
   - `腾讯云 保存失败` → 多半是**数据库权限未配置**，按第六步设置安全规则
   - `腾讯云 保存成功，共 X 条: loveBase_xxx, ...` → 说明已写入，去控制台查看
   - `腾讯云 验证失败` → 写入后读不到，可能是控制台入口不对

2. **在控制台找数据的正确入口**（容易找错）：
   - 打开 [云开发控制台](https://console.cloud.tencent.com/tcb) → 选择环境（与 config.js 的 TENCENT_ENV_ID 一致）
   - 左侧找 **「数据库」** 或 **「云开发数据库」**（不是「云数据库 MySQL」）
   - 进入后找 **「集合」** 或 **「数据集合」** 列表（不是「数据模型」）
   - 点击集合 **`LoveBase`**，在文档列表中查看
   - 每条文档有 `_id`（如 `loveBase_users`）、`key`、`value` 字段
   - 若保存后控制台显示「验证读取：LoveBase 集合当前共 0 条文档」，说明写入位置与读取位置不一致，检查环境 ID

3. **确认匿名登录已开启**：控制台 → 登录授权 → 匿名登录

4. **确认安全域名**：控制台 → 安全配置 → Web 安全域名

5. **确认集合名**：必须是 `LoveBase`，大小写一致

6. **确认数据库权限**：集合 `LoveBase` 的安全规则需包含 `"write": "auth != null"`

7. **请求超时（15s）**：若数据量很大（如大量语音留言 base64），可能超时。建议：减少语音留言数量，或删除旧留言释放空间。现已优化为只同步有变更的数据，减轻超时概率。

8. **调试读取**：在浏览器控制台输入 `__cloudbaseVerifyRead()` 可手动测试读取 LoveBase 集合，查看实际文档数量和 _id 列表。

---

**注意**：配置完成后需刷新页面。首次加载会从云端拉取数据，可能稍慢。免费额度：数据库 2GB、日 3 万次写入、5 万次读取。
