<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>留声机 - 恋爱秘密基地</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/inner.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10/dist/APlayer.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    body { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #fff5f7 0%, #ffe8ec 100%); }
    .music-standalone { max-width: 420px; width: 100%; margin: 1rem; }
    .music-search-row { display: flex; gap: 0.6rem; margin-bottom: 1rem; }
    .music-search-row input { flex: 1; padding: 0.7rem 1rem; border: 1px solid rgba(0,0,0,0.15); border-radius: 12px; font-size: 0.9rem; }
    .music-search-row button { padding: 0.7rem 1rem; border: none; border-radius: 12px; background: rgba(255,150,180,0.6); color: #fff; cursor: pointer; font-size: 0.85rem; }
    .music-search-status { text-align: center; color: #666; font-size: 0.9rem; padding: 1.5rem; margin: 0; }
  </style>
</head>
<body>
  <div class="music-standalone">
    <div class="music-window">
      <div class="music-header">
        <h3>留声机</h3>
        <span class="music-hint-mini">独立窗口，可后台播放</span>
      </div>
      <div class="music-meting-wrap">
        <div class="music-search-row">
          <input type="text" id="musicSearch" placeholder="搜索歌曲...">
          <button type="button" id="musicSearchBtn">搜索</button>
        </div>
        <div id="musicMetingContainer"></div>
      </div>
    </div>
  </div>

  <script src="js/config.js"></script>
  <script src="js/auth.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aplayer@1.10/dist/APlayer.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>
  <script>
    (function() {
      const METING_API = 'https://api.qijieya.cn/meting/';
      const NCM_APIS = ['https://ncm.zhenxin.me', 'https://zm.i9mr.com', 'https://music.mcseekeri.com'];
      const DEFAULT_PLAYLIST = '2619366284';
      const container = document.getElementById('musicMetingContainer');
      const searchInput = document.getElementById('musicSearch');
      const searchBtn = document.getElementById('musicSearchBtn');
      if (!container) return;

      window.meting_api = METING_API;
      let aplayerInstance = null;

      function renderMeting(type, id) {
        container.innerHTML = `<meting-js server="netease" type="${type}" id="${id}" api="${METING_API}" theme="#e85a7a" loop="all" list-folded="true" list-max-height="280px" volume="0.7"></meting-js>`;
      }

      renderMeting('playlist', DEFAULT_PLAYLIST);

      async function doSearch() {
        const q = searchInput.value.trim();
        if (!q) return;
        const statusEl = document.createElement('p');
        statusEl.className = 'music-search-status';
        statusEl.textContent = '搜索中...';
        container.innerHTML = '';
        container.appendChild(statusEl);

        try {
          let searchData = null;
          for (const api of NCM_APIS) {
            try {
              const r = await fetch(`${api}/search?keywords=${encodeURIComponent(q)}&limit=15`);
              if (r.ok) { searchData = await r.json(); break; }
            } catch (_) {}
          }
          if (!searchData) throw new Error('API 不可用');
          const songs = searchData?.result?.songs || [];
          if (songs.length === 0) { statusEl.textContent = '未找到歌曲'; return; }

          const ids = songs.map(s => s.id).join(',');
          let urlData = null;
          for (const api of NCM_APIS) {
            try {
              const r = await fetch(`${api}/song/url/v1?id=${ids}&level=standard`);
              if (r.ok) { urlData = await r.json(); break; }
            } catch (_) {}
          }
          if (!urlData) throw new Error('获取播放链接失败');
          const urlMap = {};
          (urlData?.data || []).forEach(d => { if (d.url) urlMap[d.id] = d.url; });

          const list = songs.filter(s => urlMap[s.id]).slice(0, 15).map(s => ({
            name: s.name,
            artist: (s.artists || []).map(a => a.name).join(' / '),
            url: urlMap[s.id],
            pic: s.album?.picId ? `https://p4.music.126.net/${s.album.picId}.jpg` : ''
          }));

          if (list.length === 0) { statusEl.textContent = '暂无可播放的歌曲'; return; }

          container.innerHTML = '<div id="aplayerSearch"></div>';
          if (aplayerInstance) aplayerInstance.destroy();
          aplayerInstance = new APlayer({
            container: document.getElementById('aplayerSearch'),
            listFolded: true,
            listMaxHeight: '280px',
            theme: '#e85a7a',
            loop: 'all',
            volume: 0.7,
            audio: list
          });
        } catch (e) {
          statusEl.textContent = '搜索失败，请重试';
        }
      }

      if (searchBtn) searchBtn.addEventListener('click', doSearch);
      if (searchInput) searchInput.addEventListener('keypress', e => e.key === 'Enter' && doSearch());
    })();
  </script>
</body>
</html>
